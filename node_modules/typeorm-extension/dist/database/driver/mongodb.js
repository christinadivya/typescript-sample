"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.dropMongoDBDatabase = exports.createMongoDBDatabase = exports.createSimpleMongoDBConnection = void 0;
const errors_1 = require("../../errors");
const utils_1 = require("./utils");
const utils_2 = require("../utils");
async function createSimpleMongoDBConnection(driver, options) {
    /**
     * mongodb library
     */
    const { MongoClient } = driver.mongodb;
    let url = 'mongodb://';
    if (options.user && options.password) {
        url += `${options.user}:${options.password}@`;
    }
    url += `${options.host || '127.0.0.1'}:${options.port || 27017}/${options.database}`;
    if (options.ssl) {
        url += '?tls=true';
    }
    const client = new MongoClient(url);
    await client.connect();
    return client;
}
exports.createSimpleMongoDBConnection = createSimpleMongoDBConnection;
async function createMongoDBDatabase(context) {
    context = await (0, utils_2.buildDatabaseCreateContext)(context);
    if (!context.options) {
        throw errors_1.OptionsError.undeterminable();
    }
    const options = (0, utils_1.buildDriverOptions)(context.options);
    const driver = (0, utils_1.createDriver)(context.options);
    // connection setup, will create the database on the fly.
    const client = await createSimpleMongoDBConnection(driver, options);
    await client.close();
    if (context.synchronize) {
        await (0, utils_2.setupDatabaseSchema)(context.options);
    }
}
exports.createMongoDBDatabase = createMongoDBDatabase;
async function dropMongoDBDatabase(context) {
    context = await (0, utils_2.buildDatabaseDropContext)(context);
    if (!context.options) {
        throw errors_1.OptionsError.undeterminable();
    }
    const options = (0, utils_1.buildDriverOptions)(context.options);
    const driver = (0, utils_1.createDriver)(context.options);
    const client = await createSimpleMongoDBConnection(driver, options);
    const result = await client.dropDatabase();
    await client.close();
    return result;
}
exports.dropMongoDBDatabase = dropMongoDBDatabase;
